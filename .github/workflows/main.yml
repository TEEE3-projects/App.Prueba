name: Deploy to IIS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
      # 1. Checkout del c贸digo fuente
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Configuraci贸n de .NET Core
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 6.0  # Cambia si usas otra versi贸n de .NET

      # 3. Publicar la aplicaci贸n
      - name: Publish app
        run: |
          dotnet publish App.Prueba/Api.Prueba/Api.Prueba.csproj -c Release -o published

      # 4. Configurar TrustedHosts
      - name: Configure TrustedHosts
        shell: pwsh
        run: |
          Set-Item -Path WSMan:\localhost\Client\TrustedHosts -Value "${{ secrets.IIS_HOST }}" -Force

      # 5. Desplegar a IIS usando PowerShell Remoting
      - name: Deploy to IIS
        shell: pwsh
        run: |
          $server = "${{ secrets.IIS_HOST }}"
          $username = "${{ secrets.IIS_USER }}"
          $password = ConvertTo-SecureString "${{ secrets.IIS_PASS }}" -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential($username, $password)

          Invoke-Command -ComputerName $server -Credential $credential -ScriptBlock {
            param($source, $target)

            # Crear el directorio de destino si no existe
            if (-Not (Test-Path -Path $target)) {
              New-Item -ItemType Directory -Force -Path $target
            }

            # Copiar archivos al servidor
            Copy-Item -Path $source/* -Destination $target -Recurse -Force
          } -ArgumentList "$(pwd)/published", "C:/App.Prueba/"
